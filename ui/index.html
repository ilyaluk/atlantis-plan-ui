<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Atlantis plan UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" rel="stylesheet"
          integrity="sha384-xeJqLiuOvjUBq3iGOjvSQSIlwrpqjSHXpduPd6rQpuiM3f5/ijby8pCsnbu5S81n" crossorigin="anonymous">
    <link href="./style.css" rel="stylesheet">
</head>
<body>
<div id="app" class="container-fluid">
    <h1 v-if="loading" class="mt-3">
        <div class="spinner-border text-dark spinner-border-sm me-1" role="status" style="width: 3rem; height: 3rem;" >
            <span class="visually-hidden">Loading...</span>
        </div>
        Loadingâ€¦
    </h1>
    <h5 class="mt-3" v-if="state.pr_num > 0">Showing plans from <a :href="state.pr_url">{{ state.pr_repo }}#{{ state.pr_num }}</a></h5>
    <div class="mt-3">
        <Stats :stacks="sortedStacks"></Stats>
    </div>

    <div class="mb-3 mt-3">
        <button @click="toggleStacks" class="btn btn-secondary btn-sm">
            <i :class="{
                'bi-chevron-expand': !expandedStacks,
                'bi-chevron-contract': expandedStacks,
            }"></i> Stacks
        </button>
        <button @click="toggleResources" class="btn btn-secondary btn-sm ms-2">
            <i :class="{
                'bi-chevron-expand': !expandedResources,
                'bi-chevron-contract': expandedResources,
            }"></i> Resources
        </button>
        <button v-if="showOutputsButton" @click="toggleOutputs" class="btn btn-l btn-sm ms-2" title="Show output changes">
            <i :class="{ 'bi-eye': showOutputs, 'bi-eye-slash': !showOutputs }"></i>
            <i class="bi-diagram-2-fill ms-2 color-blue"></i>
        </button>
        <button v-if="showDriftsButton" @click="toggleDrifts" class="btn btn-l btn-sm ms-2" title="Show remote changes">
            <i :class="{ 'bi-eye': showDrifts, 'bi-eye-slash': !showDrifts }"></i>
            <i class="bi-arrow-down-left-circle-fill ms-2 color-indigo"></i>
        </button>
        <button v-if="showMovesButton" @click="toggleMoves" class="btn btn-l btn-sm ms-2" title="Show resource moves">
            <i :class="{ 'bi-eye': showMoves, 'bi-eye-slash': !showMoves }"></i>
            <i class="bi-arrow-left-right ms-2 color-purple"></i>
        </button>
    </div>

    <div class="accordion" v-for="item in sortedStacks" >
        <Stack ref="stacks" :data="item"
               :show-outputs="showOutputs" :show-drifts="showDrifts" :show-moves="showMoves"
               :executable-name="state.executable_name"
        ></Stack>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/vue@3.2.37/dist/vue.global.js"
        integrity="sha384-SPEDmrEKb8hUMqJ37l3TUfiadBvbdeBnec/ikqEYPfBAviK7FE5oNA0ysEdqyAuQ"
        crossorigin="anonymous"></script>
<script type="module">
    import Stack from './stack.js'
    import Stats from './stats.js'
    import common from './common.js'

    const App = {
        components: { Stack, Stats },
        data() {
            return {
                loading: true,
                state: {},
                expandedStacks: false,
                expandedResources: false,
                showOutputs: true,
                showDrifts: true,
                showMoves: true,
            }
        },
        mounted() {
            let path = window.location.hash.substring(1)
            if (!path) {
                alert('This page requires a PR number in the URL hash')
                return
            }
            if (!path.match(/^[a-z0-9-_]+$/)) {
                // just to be safe from weird vulns
                alert('invalid state')
                return
            }
            fetch(`./plans/${path}.json`)
                .then(resp => resp.json())
                .then(async data => {
                    console.log(data)
                    if (data.errors) {
                        throw JSON.stringify(data.errors)
                    }
                    this.state = data
                    this.loading = false

                    await Vue.nextTick()
                    if (data.stacks.length === 1) {
                        this.expandStacks()
                    }
                })
                .catch(e => {
                    console.error(e)
                    alert("Failed to parse state json: " + e)
                })
        },
        methods: {
            toggleStacks() {
                if (this.expandedStacks) {
                    this.collapseStacks()
                } else {
                    this.expandStacks()
                }
            },
            toggleResources() {
                if (this.expandedResources) {
                    this.collapseResources()
                } else {
                    this.expandResources()
                }
            },
            expandStacks() {
                this.$refs.stacks.forEach((st) => { st.expand() })
                this.expandedStacks = true
            },
            collapseStacks() {
                if (this.expandedResources) {
                    this.collapseResources()
                }
                this.$refs.stacks.forEach((st) => { st.collapse() })
                this.expandedStacks = false
            },
            expandResources() {
                if (!this.expandedStacks) {
                    this.expandStacks()
                }
                this.$refs.stacks.forEach((st) => { st.expandAll() })
                this.expandedResources = true
            },
            collapseResources() {
                this.$refs.stacks.forEach((st) => { st.collapseAll() })
                this.expandedResources = false
            },
            toggleOutputs() {
                this.showOutputs = !this.showOutputs
            },
            toggleDrifts() {
                this.showDrifts = !this.showDrifts
            },
            toggleMoves() {
                this.showMoves = !this.showMoves
            },

        },
        computed: {
            showOutputsButton() {
                if (!this.state.stacks) {
                    return false
                }
                return common.stacksWithOutputChanges(this.state.stacks).length > 0
            },
            showDriftsButton() {
                if (!this.state.stacks) {
                    return false
                }
                return common.stacksWithDrifts(this.state.stacks).length > 0
            },
            showMovesButton() {
                if (!this.state.stacks) {
                    return false
                }
                return common.stacksWithMoves(this.state.stacks).length > 0
            },
            sortedStacks() {
                if (!this.state.stacks) {
                    return []
                }
                let sortStacks = (ss) => {
                    ss.sort((l, r) => l.path.localeCompare(r.path))
                }
                let changed = common.stacksWithAnyChange(this.state.stacks)
                sortStacks(changed)
                let errored = common.erroredStacks(this.state.stacks)
                sortStacks(errored)
                let locked = common.lockedStacks(this.state.stacks)
                sortStacks(locked)
                let zerodiff = common.stacksWithZeroDiff(this.state.stacks)
                sortStacks(zerodiff)
                return [].concat(changed, errored, locked, zerodiff)
            },
        }
    }

    Vue.createApp(App).mount("#app")
</script>
</body>
</html>